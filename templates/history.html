<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</title>
  <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div class="header">
    <div class="header-left">
      –£—á—ë—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏
      <!--{% if current_user.role == "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ" %}
      <button id="adminMenuToggle" onclick="toggleAdminMenu()">‚öôÔ∏è</button>
      {% endif %}-->
    </div>
  
    <div class="profile">
      <strong>{{ current_user.role }}</strong> <strong>{{ fullname }}</strong> |
      <a href="/logout" style="color: white;">–í—ã–π—Ç–∏</a>
    </div>
  </div>
  
  <!-- –ú–µ–Ω—é –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è -->
  <!--{% if current_user.role == "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ" %}
  <div id="adminMenu" class="context-menu" style="display: none;">
    <button onclick="openDepartmentModal()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</button>-->

    <!-- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏ –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–∑–∂–µ -->
  </div>
  <!--{% endif %}-->
  
  
  <div class="tabs">
    <a class="tab-btn" href="/">–£—á—ë—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏</a>
    <a class="tab-btn active" href="/history">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</a>
    <a class="tab-btn" href="/modernization">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏–∏</a>
  </div>
  

  <div class="section">
    <label>–ü–æ–∏—Å–∫ –ø–æ –¥–∞—Ç–µ:</label>
    <input type="text" id="dateFilter" oninput="filterHistory()" />
    <label>–ü–æ–∏—Å–∫ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</label>
    <input type="text" id="userFilter" oninput="filterHistory()" />
    <label>–ü–æ–∏—Å–∫ –ø–æ TL-WS:</label>
    <input type="text" id="pcFilter" oninput="filterHistory()" />
    
    <button onclick="clearFilters()" class="clear-filters-btn">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</button>

  </div>

  <table id="history-table">
    <thead>
      <tr>
        <th>–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</th>
        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
        <th>–î–∞—Ç–∞</th>
        <th>–°—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
        <th>–ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  
  <button id="loadMore" style="margin-top: 20px;">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button>

  

  

  <form action="/report/history/excel" method="get" style="display:inline;">
    <button class="excel-history-button" title="–°–∫–∞—á–∞—Ç—å Excel: –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π">üì•</button>
  </form>
  

  <script>
let currentPage = 1;
const tableBody = document.querySelector("table tbody");
const loadMoreButton = document.getElementById("loadMore");

function loadHistoryPage(page) {
  fetch(`/api/history?page=${page}`)
    .then(response => response.json())
    .then(data => {
      data.entries.forEach(entry => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${entry.pc}</td>
          <td>${entry.user}</td>
          <td>${entry.date}</td>
          <td>${entry.old}</td>
          <td>${entry.new}</td>
        `;
        tableBody.appendChild(row);
      });

      if (page >= data.total_pages) {
        loadMoreButton.style.display = "none";
      }
    })
    .catch(error => {
      console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:", error);
    });
}

loadMoreButton.addEventListener("click", () => {
  currentPage++;
  loadHistoryPage(currentPage);
});

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
loadHistoryPage(currentPage);

document.addEventListener("DOMContentLoaded", () => loadPage(1)); 

function filterHistory() {
  const date = document.getElementById("dateFilter").value;
  const user = document.getElementById("userFilter").value.toLowerCase();
  const pc = document.getElementById("pcFilter").value.toLowerCase();

  const rows = document.querySelectorAll("#history-table tr");

  rows.forEach((row, index) => {
    if (index === 0) return; // –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫

    const dateCol = row.children[2].textContent.trim();
    const userCol = row.children[1].textContent.toLowerCase();
    const pcCol = row.children[0].textContent.toLowerCase();

    const match =
      (date === "" || dateCol.startsWith(date)) &&
      userCol.includes(user) &&
      pcCol.includes(pc);

    row.style.display = match ? "" : "none";
  });
}

function clearFilters() {
  document.getElementById("dateFilter").value = "";
  document.getElementById("userFilter").value = "";
  document.getElementById("pcFilter").value = "";
  filterHistory();
}



    
  window.onload = loadHistory;





</script>
    
</body>
</html>
