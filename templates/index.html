<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–£—á—ë—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>

  <div class="header">
    <div class="header-left">
      –£—á—ë—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏
      {% if current_user.role == "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ" %}
      <button id="adminMenuToggle" onclick="toggleAdminMenu()">‚öôÔ∏è</button>
      {% endif %}
    </div>
  
    <div class="profile">
      <strong>{{ current_user.role }}</strong> <strong>{{ fullname }}</strong> |
      <a href="/logout" style="color: white;">–í—ã–π—Ç–∏</a>
    </div>
  </div>
  
  <!-- –ú–µ–Ω—é –¥–ª—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è -->
  {% if current_user.role == "–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ" %}
  <div id="adminMenu" class="context-menu" style="display: none;">
    <button onclick="openDepartmentModal()" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ">üè¢</button>
    <button onclick="openUserManagementModal()" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã">üë§</button>
    <button onclick="openPCUserModal()" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–ö">üßë‚Äçüíª</button>
    <!-- –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∏ –¥—Ä—É–≥–∏–µ –∫–Ω–æ–ø–∫–∏ –ø–æ–∑–∂–µ -->
  </div>
  {% endif %}
  <div class="tabs">
    <a class="tab-btn active" href="/">–£—á—ë—Ç –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–π —Ç–µ—Ö–Ω–∏–∫–∏</a>
    <a class="tab-btn" href="/history">–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π</a>
    <a class="tab-btn" href="/modernization">–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ—Ä–Ω–∏–∑–∞—Ü–∏–∏</a>
  </div>


    <div class="main-panel">
      <!-- –õ–µ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
      <div class="left-panel">
        <label for="departmentSelect"><strong>–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:</strong></label>
        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
          <select id="departmentSelect" onchange="fetchComputersByDepartment()"></select>
          
          <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
          <button id="delete-btn" class="tooltip-btn delete-btn">
            üóëÔ∏è
          <span class="tooltip-text delete-tooltip">–£–¥–∞–ª–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä</span>
          </button>

          <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
          <button id="add-btn" class="tooltip-btn add-btn" onclick="addNewComputer()">
          ‚ûï
          <span class="tooltip-text add-tooltip">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä</span>
          </button>

          
          <form action="/report/inventory/excel" method="get">
            <button class="excel-inventory-button" title="–°–∫–∞—á–∞—Ç—å Excel: –£—á–µ—Ç —Ç–µ—Ö–Ω–∏–∫–∏">üì•</button>
          </form>
          
        </div>
        
      
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∫–æ–º–ø—å—é—Ç–µ—Ä—É –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é" oninput="filterComputers()" />


        <div id="computerList">
          <!-- –°—é–¥–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∫–æ–º–ø—å—é—Ç–µ—Ä—ã -->
        </div>
      </div>
      
            <!-- –ü—Ä–∞–≤–∞—è –ø–∞–Ω–µ–ª—å -->
<div class="right-panel">
  <div class="computer-details">
    <div class="details-header">
      <button id="edit-button" onclick="enableEditing()">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
      <button id="cancel-button" onclick="cancelEditing()" style="display:none;">–û—Ç–º–µ–Ω–∞</button>
      <button id="save-button" onclick="saveComputer()" disabled>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  
    <div class="details-body">
      <label>–ò–º—è –∫–æ–º–ø—å—é—Ç–µ—Ä–∞</label>
      <input type="text" id="pc_name" name="pc_name" class="pc-field" disabled />
  
      <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
      <input type="text" id="sam_account_name" name="sam_account_name" list="userList" class="pc-field" disabled />
      <datalist id="userList"></datalist>

  
      <label>–¢–∏–ø —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</label>
      <select id="device_type" name="type" class="pc-field" disabled>
        <option value="–ö–æ–º–ø—å—é—Ç–µ—Ä">–ö–æ–º–ø—å—é—Ç–µ—Ä</option>
        <option value="–ù–æ—É—Ç–±—É–∫">–ù–æ—É—Ç–±—É–∫</option>
      </select>
  
      <label>–ü—Ä–æ—Ü–µ—Å—Å–æ—Ä</label>
      <input type="text" id="processor" list="processorList" />
      <datalist id="processorList"></datalist>
  
      <label>–û–ø–µ—Ä–∞—Ç–∏–≤–Ω–∞—è –ø–∞–º—è—Ç—å</label>
      <input type="text" id="ram" name="ram" class="pc-field" disabled />
  
      <label>–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å</label>
      <input type="text" id="storage" list="storageList" />
      <datalist id="storageList"></datalist>

      <label>–ú–æ–Ω–∏—Ç–æ—Ä</label>
      <input type="text" id="monitor" list="monitorList" />
      <datalist id="monitorList"></datalist>
    </div>
  </div>
  </div>
  
  
    <div class="tab-content"></div>
    <div class="tab-content"></div>
  
    <div class="overlay" id="department-overlay">
      <div class="modal">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ</h2>
        <input type="text" id="new-department-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è" />
        <div class="buttons">
          <button onclick="addDepartment()">–î–æ–±–∞–≤–∏—Ç—å</button>
          <button onclick="closeDepartmentModal()">–û—Ç–º–µ–Ω–∞</button>
        </div>
        <div id="department-error" class="error-msg"></div>
      </div>
    </div>
    
    </div>

    <!-- –û–≤–µ—Ä–ª–µ–π –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–ö -->
<div id="pcUserModal" class="overlay">
  <div class="modal">
    <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ü–ö</h2>
    <input type="text" id="pcUserLogin" placeholder="–õ–æ–≥–∏–Ω (sam_account_name)">
    <input type="text" id="pcUserName" placeholder="–§–ò–û (cn)">
    <input type="text" id="pcUserDepartment" list="departmentList" placeholder="–ü–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ (title)">
    <datalist id="departmentList"></datalist>
    <input type="text" id="pcUserID" placeholder="–¢–∞–±–µ–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä (employeeID)">
    <div class="buttons">
      <button onclick="submitPCUser()">–î–æ–±–∞–≤–∏—Ç—å</button>
      <button onclick="closePCUserModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
    <div id="pcUserError" class="error-msg"></div>
  </div>
</div>


<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ -->
<div id="userManagementModal" class="user-modal" style="display: none;">
  <div class="user-modal-content">
    <span class="close" onclick="closeUserManagementModal()">&times;</span>
    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ –ø—Ä–æ–≥—Ä–∞–º–º—ã</h2>

    <table id="userTable">
      <thead>
        <tr>
          <th>–ò–º—è</th>
          <th>–†–æ–ª—å</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <button onclick="openAddUserForm()">–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</button>




    <div id="addUserForm" style="display: none; margin-top: 20px;">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h3>
      <form id="newUserForm">
        <label for="newUsername">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:</label>
        <input type="text" id="newUsername" name="username" required>

        <label for="newFullname">–ü–æ–ª–Ω–æ–µ –∏–º—è:</label>
        <input type="text" id="newFullname" name="fullname" required>

        <label for="newRole">–†–æ–ª—å:</label>
        <select id="newRole" name="role" required>
          <option value="–°–æ—Ç—Ä—É–¥–Ω–∏–∫">–°–æ—Ç—Ä—É–¥–Ω–∏–∫</option>
          <option value="–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ">–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ</option>
        </select>

        <label for="newPassword">–ü–∞—Ä–æ–ª—å:</label>
        <input type="password" id="newPassword" name="password" required>

        <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button type="button" onclick="clearUserForm()">–û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É</button>
        <button type="button" onclick="closeAddUserForm()">–û—Ç–º–µ–Ω–∞</button>
      </form>
    </div>
  </div>
</div>


</body>
  <!-- JS -->
  <script>
    let selectedPcId = null;
  
    async function fetchDepartments() {
      const res = await fetch('/api/departments');
      const departments = await res.json();
      const select = document.getElementById('departmentSelect');
      select.innerHTML = '';
      departments.forEach(dep => {
        const option = document.createElement('option');
        option.value = dep;
        option.textContent = dep;
        select.appendChild(option);
      });
      fetchComputersByDepartment();
    }
    
    function filterComputers() {
     const query = document.getElementById("searchInput").value.toLowerCase();
     const items = document.querySelectorAll(".computer-item");

      items.forEach(item => {
       const text = item.textContent.toLowerCase();
        if (text.includes(query)) {
          item.style.display = "";
        } else {
        item.style.display = "none";
        }
        });
      }

  
    async function fetchComputersByDepartment() {
      const department = document.getElementById('departmentSelect').value;
      const res = await fetch(`/api/computers?department=${encodeURIComponent(department)}`);
      const computers = await res.json();
      const list = document.getElementById('computerList');
      list.innerHTML = '';
      computers.forEach(c => {
        const div = document.createElement('div');
        div.className = 'computer-item';
        div.textContent = `üíª ${c.pc_name} / ${c.sam_account_name}`;
      div.onclick = () => {
        selectedPcId = c.pc_name;
        highlightSelected(c.pc_name);
        loadComputerDetails(c.pc_name);
        };
        div.dataset.id = c.pc_name;
      list.appendChild(div);
    });

    }
  
    function highlightSelected(pcId) {
      const items = document.querySelectorAll('.computer-item');
      items.forEach(item => {
        if (item.dataset.id === pcId) {
          item.classList.add('selected');
        } else {
          item.classList.remove('selected');
        }
      });
    }

  function openUserManagementModal() {
  document.getElementById('userManagementModal').style.display = 'block';
  loadUserList();
}

function closeUserManagementModal() {
  document.getElementById('userManagementModal').style.display = 'none';
}

function loadUserList() {
  fetch('/api/users')
    .then(response => response.json())
    .then(data => {
      const tbody = document.querySelector('#userTable tbody');
      tbody.innerHTML = '';
      data.forEach(user => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${user.fullname}</td>
          <td>${user.role}</td>
          <td>
            <button onclick="editUser('${user.username}', '${user.fullname}', '${user.role}')">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button onclick="deleteUser('${user.username}')">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        `;
        tbody.appendChild(row);
      });
    });
}

function editUser(username, fullname, role) {
  document.getElementById('newUsername').value = username;
  document.getElementById('newUsername').disabled = true;
  document.getElementById('newFullname').value = fullname;
  document.getElementById('newRole').value = role;
  document.getElementById('newPassword').value = '';
  document.getElementById('addUserForm').style.display = 'block';
}

function deleteUser(username) {
  if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}"?`)) {
    fetch(`/api/users/${username}`, {
      method: 'DELETE'
    })
    .then(res => {
      if (res.ok) {
        alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª—ë–Ω");
        loadUserList();
      } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
      }
    });
  }
}


// –û—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function openAddUserForm() {
  document.getElementById('addUserForm').style.display = 'block';
}

function clearUserForm() {
  document.getElementById('newUsername').value = '';
  document.getElementById('newUsername').disabled = false;
  document.getElementById('newFullname').value = '';
  document.getElementById('newRole').value = '–°–æ—Ç—Ä—É–¥–Ω–∏–∫';
  document.getElementById('newPassword').value = '';
}

// –ó–∞–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function closeAddUserForm() {
  document.getElementById('addUserForm').style.display = 'none';
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
document.getElementById('newUserForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const username = document.getElementById('newUsername').value;
  const fullname = document.getElementById('newFullname').value;
  const role = document.getElementById('newRole').value;
  const password = document.getElementById('newPassword').value;

  const method = document.getElementById('newUsername').disabled ? 'PUT' : 'POST';
  const url = method === 'PUT' ? `/api/users/${username}` : '/api/users';

  fetch(url, {
    method: method,
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ username, fullname, role, password })
  })
  .then(response => {
    if (response.ok) {
      alert(method === 'PUT' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω');
      closeAddUserForm();
      loadUserList();
    } else {
      response.json().then(err => alert(err.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'));
    }
  });
});

function openPCUserModal() {
  document.getElementById("pcUserModal").style.display = "flex";
  document.getElementById("pcUserError").textContent = "";
  loadDepartmentsDatalist();  // –ù–æ–≤—ã–π –≤—ã–∑–æ–≤
}

async function loadDepartmentsDatalist() {
  const res = await fetch('/api/departments');
  const departments = await res.json();
  const list = document.getElementById('departmentList');
  list.innerHTML = '';
  departments.forEach(d => {
    const option = document.createElement('option');
    option.value = d;
    list.appendChild(option);
  });
}


function closePCUserModal() {
  document.getElementById("pcUserModal").style.display = "none";
}

async function submitPCUser() {
  const login = document.getElementById("pcUserLogin").value.trim();
  const cn = document.getElementById("pcUserName").value.trim();
  const title = document.getElementById("pcUserDepartment").value.trim();
  const id = document.getElementById("pcUserID").value.trim();

  if (!login || !cn || !title || !id) {
    document.getElementById("pcUserError").textContent = "–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è";
    return;
  }

  const res = await fetch("/api/pc-users", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ sam_account_name: login, cn, title, employeeID: id })
  });

  const result = await res.json();
  if (res.ok) {
    alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ü–ö –¥–æ–±–∞–≤–ª–µ–Ω");
    closePCUserModal();
  } else {
    document.getElementById("pcUserError").textContent = result.message || "–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏";
  }
}

  
    async function loadComputerDetails(pcName) {
      const res = await fetch(`/api/computer/${encodeURIComponent(pcName)}`);
      const data = await res.json();
      if (data.error) return;
  
      document.getElementById('pc_name').value = data.pc_name;
      document.getElementById('sam_account_name').value = data.full_name || data.sam_account_name; // –§–ò–û
      
      document.getElementById('processor').value = data.processor;
      document.getElementById('storage').value = data.storage;
      document.getElementById('monitor').value = data.monitor;
      document.getElementById('ram').value = data.ram;
      document.getElementById('device_type').value = data.type;
    }
  
    function addNewComputer() {
  clearForm();
  enableEdit(true);
  selectedPcId = null;
  loadPcUserDatalist();
}

function toggleAdminMenu() {
  const menu = document.getElementById("adminMenu");
  menu.style.display = menu.style.display === "none" ? "block" : "none";
}

document.addEventListener("click", function (e) {
  if (!e.target.closest("#adminMenu") && !e.target.closest("#adminMenuToggle")) {
    const menu = document.getElementById("adminMenu");
    if (menu) menu.style.display = "none";
  }
});


function enableEdit(editing) {
  const fields = document.querySelectorAll('#pc_name, #sam_account_name, #processor, #storage, #monitor, #ram, #device_type');
  fields.forEach(f => f.disabled = !editing);
  document.querySelector('button[onclick="saveComputer()"]').disabled = !editing;
}

document.getElementById('delete-btn').addEventListener('click', async () => {
  if (!selectedPcId) {
    alert("–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º–ø—å—é—Ç–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è");
    return;
  }

  const confirmed = confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–æ–º–ø—å—é—Ç–µ—Ä "${selectedPcId}"?`);

  if (confirmed) {
    const res = await fetch(`/api/computer/${selectedPcId}`, {
      method: 'DELETE',
    });

    if (res.ok) {
      alert("–ö–æ–º–ø—å—é—Ç–µ—Ä —É–¥–∞–ª—ë–Ω");
      fetchComputersByDepartment();
      clearForm();
      selectedPcId = null;
    } else {
      alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏");
    }
  }
});

function loadProcessorDatalist() {
  fetch('/api/components/processors')
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('processor-list');
      list.innerHTML = '';
      data.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        list.appendChild(opt);
      });
    });
}

function loadStorageDatalist() {
  fetch('/api/components/storages')
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('storage-list');
      list.innerHTML = '';
      data.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s;
        list.appendChild(opt);
      });
    });
}

function loadMonitorDatalist() {
  fetch('/api/components/monitors')
    .then(res => res.json())
    .then(data => {
      const list = document.getElementById('monitor-list');
      list.innerHTML = '';
      data.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        list.appendChild(opt);
      });
    });
}


function clearForm() {
  document.getElementById('pc_name').value = '';
  document.getElementById('sam_account_name').value = '';
  document.getElementById('processor').value = '';
  document.getElementById('storage').value = '';
  document.getElementById('monitor').value = '';
  document.getElementById('ram').value = '';
  document.getElementById('device_type').value = '–ö–æ–º–ø—å—é—Ç–µ—Ä';
}



async function saveComputer() {
  const body = {
    pc_name: document.getElementById('pc_name').value,
    sam_account_name: document.getElementById('sam_account_name').value,
    processor: document.getElementById('processor').value,
    storage: document.getElementById('storage').value,
    monitor: document.getElementById('monitor').value,
    ram: document.getElementById('ram').value,
    type: document.getElementById('device_type').value,
    department: document.getElementById('departmentSelect').value
  };

  const method = selectedPcId ? 'PUT' : 'POST';
  const url = selectedPcId ? `/api/computer/${selectedPcId}` : `/api/computer`;

  const res = await fetch(url, {
    method,
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  if (res.ok) {
    alert(selectedPcId ? '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã' : '–ö–æ–º–ø—å—é—Ç–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω');
    enableEdit(false);
    fetchComputersByDepartment();
  } else {
    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏');
  }
}


    window.onload = () => {
  fetchDepartments();
  loadCustomFields();
};

function openDepartmentModal() {
  document.getElementById("department-overlay").style.display = "flex";
  document.getElementById("new-department-name").value = "";
  document.getElementById("department-error").textContent = "";
}

function closeDepartmentModal() {
  document.getElementById("department-overlay").style.display = "none";
}

async function addDepartment() {
  const name = document.getElementById("new-department-name").value.trim();
  if (!name) {
    document.getElementById("department-error").textContent = "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ";
    return;
  }

  const res = await fetch("/api/add-department", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name })
  });

  const result = await res.json();
  if (result.status === "ok") {
    closeDepartmentModal();
    fetchDepartments(); // –æ–±–Ω–æ–≤–∏–º —Å–ø–∏—Å–æ–∫
  } else {
    document.getElementById("department-error").textContent = result.message;
  }
}
let originalValues = {};

function enableEditing() {
  originalValues = {};
  document.querySelectorAll('.pc-field').forEach(input => {
    input.disabled = false;
    originalValues[input.name] = input.value;
  });
  document.getElementById('edit-button').style.display = 'none';
  document.getElementById('cancel-button').style.display = 'inline-block';
  document.getElementById('save-button').disabled = false;
  loadPcUserDatalist();  // –ü–æ–¥–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

}

async function loadPcUserDatalist() {
  const res = await fetch('/api/all-pc-users');
  const users = await res.json();
  const list = document.getElementById('userList');
  list.innerHTML = '';
  users.forEach(user => {
    const option = document.createElement('option');
    option.value = user.sam_account_name;
    option.textContent = user.cn;
    list.appendChild(option);
  });
}


function cancelEditing() {
  document.querySelectorAll('.pc-field').forEach(input => {
    input.value = originalValues[input.name];
    input.disabled = true;
  });
  document.getElementById('edit-button').style.display = 'inline-block';
  document.getElementById('cancel-button').style.display = 'none';
  document.getElementById('save-button').disabled = true;
}

function saveChanges() {
  const pcName = document.getElementById("pc_name").value;
  const data = {};
  document.querySelectorAll(".pc-field").forEach(input => {
    data[input.name] = input.value;
  });

  fetch(`/api/computer/${encodeURIComponent(pcName)}`, {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  }).then(res => {
    if (res.ok) {
      alert("‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã");
      cancelEditing();
      loadComputers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
    } else {
      alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏");
    }
  });
}

function copyComputer() {
  const data = {};
  document.querySelectorAll('.pc-field').forEach(input => {
    data[input.name] = input.value;
  });

  data.pc_name += "-COPY"; // –£–Ω–∏–∫–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–º—è

  fetch('/api/computer', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(data)
  }).then(res => {
    if (res.ok) {
      alert('‚úÖ –ö–æ–º–ø—å—é—Ç–µ—Ä —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω');
      loadComputers();
    } else {
      alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å');
    }
  });
}



</script>
</html>
